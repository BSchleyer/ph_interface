<?php
 @media only screen and (max-width:799px){body{width: auto !important;}.display-width{width: 100% !important;}.res-padding{padding: 0 20px !important;}.display-width-inner{width: 600px !important;}.res-center{text-align: center !important; width: 100% !important;}.width800{width: 100% !important; max-width: 100% !important;}}@media only screen and (max-width:768px){.width768{max-width: 684px !important;}.width385{max-width: 385px !important;}.vision-mission{width: 56% !important; max-width: 56% !important;}.mission-vision{width: 44% !important; max-width: 44% !important;}.padding-soft30{padding: 38px 15px !important;}.padding-app30{padding: 69px 15px !important;}}@media only screen and (max-width:660px){.vision-mission{width: 50% !important; max-width: 50% !important;}.width385{max-width: 291px !important;}.mission-vision{width: 50% !important; max-width: 50% !important;}.res-padding-left{padding-left: 20px;}.res-padding-right{padding-right: 20px;}.padding-soft30{padding: 53px 15px !important;}.padding-app30{padding: 38px 15px !important;}}@media only screen and (max-width:640px){.vision-mission{width: 50% !important; max-width: 50% !important;}.width385{max-width: 301px !important;}.mission-vision{width: 50% !important; max-width: 50% !important;}.res-padding-left{padding-left: 20px;}.res-padding-right{padding-right: 20px;}.padding-soft30{padding: 47px 15px !important;}.padding-app30{padding: 30px 15px !important;}}@media only screen and (max-width:639px){.display-width-inner, .display-width-child{width: 100% !important;}td[class="height-hidden"]{display: none !important;}.height20{height: 20px !important;}.height10{height: 10px !important;}.height30{height: 30px !important;}.height40{height: 40px !important;}.padding60{padding-bottom: 60px !important;}.res-padding-full{padding: 0 20px !important;}.text-center{text-align: center !important;}.padding-hide{padding: 0px !important;}.image-center{margin: 0 auto !important; display: table !important;}.btn-center{margin: 0 auto !important; display: table !important;}.div-width{display: block !important; width: 100% !important; max-width: 100% !important;}.padding-tb30{padding-top: 60px !important; padding-bottom: 30px !important;}.res-padding-left{padding-left: 0px !important;}.res-padding-right{padding-right: 0px !important;}.width292{width: 292px !important;}.3-col{width: 196px !important;}.saf-table{display: block !important;}}@media only screen and (max-width:480px){.display-width table{width: 100% !important;}.button-width .display-button{width: auto !important;}.div-width{display: block !important; width: 100% !important; max-width: 100% !important;}.display-width .width292{width: 292px !important;}.display-width .3-col{width: 292px !important;}}@media only screen and (max-width:387px){.product, .product-content{font-size: 14px !important; font-weight: normal !important; padding: 5px !important;}}@media only screen and (max-width:360px){.display-width-child .width292{width: 100% !important;}.display-width-child .3-col{width: 100% !important;}}@media only screen and (max-width:340px){.hide-bar{display: none !important;}.product, .product-content{font-size: 12px !important; font-weight: normal !important; padding: 5px !important;}}@media only screen and (max-width:320px){.hide-bar{display: none !important;}.product, .product-content{font-size: 10px !important; font-weight: normal !important; padding: 5px !important;}}@media only screen and (max-width:300px){.hide-bar{display: none !important;}.product, .product-content{font-size: 10px !important; font-weight: normal !important; padding: 5px !important;}.display-width .butn{width: 260px !important;}}</style> </head> <body> <table align="center" bgcolor="#333333" border="0" cellpadding="0" cellspacing="0" width="100%"> <tbody> <tr> <td align="center"> <div style="display:inline-block; width:100%; max-width:800px; vertical-align:top;" class="width800"> <table align="center" bgcolor="#ffffff" border="0" cellpadding="0" cellspacing="0" class="display-width" width="100%" style="max-width:800px;"> <tbody> <tr> <td align="center" class="res-padding"> <div style="display:inline-block; width:100%; max-width:600px; vertical-align:top;" class="width600"> <table align="center" border="0" class="display-width-inner" cellpadding="0" cellspacing="0" width="100%" style="max-width:600px;"> <tr> <td height="15" class="height20" style="mso-line-height-rule:exactly; line-height:15px; font-size:0;"> </td></tr><tr> <td align="center" style="border-collapse:collapse; width:100%; max-width:100%; font-size:0;"> <div style="display:inline-block; max-width:150px; width:100%; vertical-align:top;" class="div-width"> <table align="center" border="0" cellpadding="0" cellspacing="0" class="display-width-child" width="100%" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; width:100%; max-width:100%;"> <tr> <td align="center"> <table align="center" border="0" cellpadding="0" cellspacing="0" style="width:auto !important;"> <tr> <td align="center" style="color:#333333;"> <a href="https://prohosting24.de" style="color:#333333; text-decoration:none;"><img src="{{{logourl}}}" width="300" height="77" style="margin:0; border:0; padding:0; display:block;"/></a> </td></tr></table> </td></tr></table> </div><div style="display:inline-block; width:100%; max-width:445px; vertical-align:top;" class="div-width"> <table align="center" border="0" cellpadding="0" cellspacing="0" class="display-width-child" width="100%" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; width:100%; max-width:100%;"> <tr> <td align="center" style="border-collapse:collapse; font-size:0;"> <div style="display:inline-block; width:100%; max-width:320px; vertical-align:top;" class="div-width"> <table align="left" border="0" cellpadding="0" cellspacing="0" class="display-width-child" width="100%" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; width:100%; max-width:210px;"> <tr> <td width="100%" style="font-size:0;"> </td></tr></table> </div><div style="display:inline-block; width:100%; max-width:120px; vertical-align:top;" class="div-width"> <table align="right" border="0" cellpadding="0" cellspacing="0" class="display-width-child" width="100%" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; width:100%; max-width:100%;"> <tr> <td align="center" style="font-size:0;"> <table align="center" border="0" cellpadding="0" cellspacing="0" class="display-width-child" width="100%" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt; width:100%; max-width:120px;"> <tr> <td align="center"> <table align="center" border="0" width="100%" cellpadding="0" cellspacing="0"> <tr> <td height="16" class="heigh10" style="mso-line-height-rule:exactly; line-height:16px; font-size:0;"> </td></tr><tr> <td align="right" class="MsoNormal" style="color:#666666; font-family: Arial, Helvetica Neue, Helvetica, sans-serif; font-size:13px; font-weight:400; letter-spacing:1px;"> <a href="#" style="color:#666666; text-decoration:none;"> </a> </td></tr><tr> <td height="16" class="height-hidden" style="mso-line-height-rule:exactly; line-height:16px; font-size:0;"> </td></tr></table> </td></tr></table> </td></tr></table> </div></td></tr></table> </div></td></tr><tr> <td height="15" class="height20" style="mso-line-height-rule:exactly; line-height:15px; font-size:0;"> </td></tr></table> </div></td></tr></tbody> </table> </div></td></tr></tbody> </table>';
    }

    public function addmail($template, $userid, $data)
    {
        $this->masterdatabase->insert("mail_queue", [
            "userid" => $userid,
            "template" => $template,
            "done" => 1,
            "data" => json_encode($data),
        ]);
        $this->sendmail($template, $userid, $data, Functions::$dependencyInjector);
    }

    public function getqueue($limit = 30)
    {
        return $this->masterdatabase->select("mail_queue", [
            "id",
            "userid",
            "template",
            "data",
        ], [
            "done" => 0,
            "LIMIT" => $limit,
        ]);
    }

    public function setmaildone($queueid)
    {
        
        $this->masterdatabase->update("mail_queue", [
            "done" => 1,
        ], [
            "id" => $queueid,
        ]);
    }

    public function sendmail($template, $userid, $data, DependencyInjector $dependencyInjector)
    {
        $this->dependencyInjector = $dependencyInjector;
        
        $user = new User();
        $user->load_id($this->masterdatabase, $userid);

        $lang = new LanguageMaster($dependencyInjector, $user->getLang());

        $dependencyInjector->setLang($lang);

        if ($user->getStatus() == 3) {
            return true;
        }
        if ($this->forcedreceiver != "") {
            $targetemail = $this->forcedreceiver;
        } else {
            $targetemail = $user->getEmail();
        }
        $targetname = $user->getVorname() . " " . $user->getNachname();

        
        $templateinfo = $this->masterdatabase->select("mail_templates", [
            "title",
            "data",
            "data_nohtml",
        ], [
            "name" => $template,
        ]);

        if (count($templateinfo) != 1) {
            return false;
        }
        $htmlheader = $this->htmlheader;
        $htmlfooter = $this->htmlfooter;
        $title = $templateinfo[0]["title"];
        $body = $htmlheader . $templateinfo[0]["data"] . $htmlfooter;
        $body_nohtml = $templateinfo[0]["data_nohtml"];

        if(is_array($data)){
            $data["name"] = strip_unsafe($targetname);
        } else {
            $data = [];
            $data["name"] = strip_unsafe($targetname);
        }
        $body = $this->convertEmailContent($body, $data, $dependencyInjector);
        $body_nohtml = $this->convertEmailContent($body_nohtml, $data, $dependencyInjector);
        $title = $this->convertEmailContent($title, $data, $dependencyInjector);

        $data = [
            "body" => $body,
            "bodyNoHtml" => $body_nohtml,
            "title" => $title,
            "name" => $data["name"],
            "mail" => $targetemail,
            "MessageID" => "<" . md5('HELLO'.(idate("U")-1000000000).uniqid()).'-'.$userid.'@prohosting24.de>'
        ];
        $connection = new AMQPStreamConnection($this->dependencyInjector->getConfig()->getconfigvalue("rabbitmq")["ip"],
            $this->dependencyInjector->getConfig()->getconfigvalue("rabbitmq")["port"],
            $this->dependencyInjector->getConfig()->getconfigvalue("rabbitmq")["username"],
            $this->dependencyInjector->getConfig()->getconfigvalue("rabbitmq")["password"],
        );
        $channel = $connection->channel();

        $channel->queue_declare('ph24_mail', false, true, false, false);

        $msg = new AMQPMessage(json_encode($data));
        $channel->basic_publish($msg, '', 'ph24_mail');

        return true;
    }

    public function convertEmailContent($content, $data, DependencyInjector $dependencyInjector)
    {
        foreach ($data as $key => $value) {
            $content = str_replace("{{ " . $key . " }}", strip_unsafe($value), $content);
        }

        $data = Functions::getInbetweenStrings("{{{", "}}}", $content);
        foreach ($data as $langTag) {
            $content = str_replace("{{{" . $langTag . "}}}", $dependencyInjector->getLang()->getString($langTag), $content);
        }
        return $content;
    }

    public function gettemplates()
    {
        return $this->masterdatabase->select("mail_templates", [
            "id",
            "name",
            "title",
            "created_on",
        ]);
    }

    public function getSingleEmail($userid, $id)
    {
        return $this->masterdatabase->select("mail_queue", [
            "[>]mail_templates" => ["template" => "name"],
        ], [
            "mail_queue.id",
            "mail_queue.template",
            "mail_templates.title",
            "mail_queue.done",
            "mail_queue.data",
            "mail_queue.created_on",
        ], [
            "mail_queue.userid" => $userid,
            "mail_queue.id" => $id,
        ]);
    }

    public function gettemplatename($name)
    {
        $template = $this->masterdatabase->select("mail_templates", [
            "id",
            "name",
            "title",
            "created_on",
            "data",
            "data_nohtml",
        ], [
            "name" => $name,
        ]);
        $template[0]["header"] = $this->htmlheader;
        $template[0]["htmlfooter"] = $this->htmlfooter;
        return $template;
    }

    public function gettemplate($id)
    {
        $template = $this->masterdatabase->select("mail_templates", [
            "id",
            "name",
            "title",
            "created_on",
            "data",
            "data_nohtml",
        ], [
            "id" => $id,
        ]);
        print_r($template);die();
        $template[0]["header"] = $this->htmlheader;
        $template[0]["htmlfooter"] = $this->htmlfooter;
        return $template;
    }

    public function addtemplate($name, $title, $data, $date_nohtml)
    {
        return $this->masterdatabase->insert("mail_templates", [
            "name" => $name,
            "title" => $title,
            "data" => $data,
            "data_nohtml" => $date_nohtml,
        ]);
    }

    public function updatetemplate($id, $name, $title, $data, $date_nohtml)
    {
        return $this->masterdatabase->update("mail_templates", [
            "name" => $name,
            "title" => $title,
            "data" => $data,
            "data_nohtml" => $date_nohtml,
        ], [
            "id" => $id,
        ]);
    }

    public function getemailsbyuserid($userid ,$limit = 0)
    {
        if($limit != 0){
            return $this->masterdatabase->select("mail_queue", [
                "[>]mail_templates" => ["template" => "name"],
            ], [
                "mail_queue.id",
                "mail_queue.template",
                "mail_templates.title",
                "mail_queue.done",
                "mail_queue.data",
                "mail_queue.created_on",
            ], [
                "mail_queue.userid" => $userid,
                "ORDER" => ["id" => "DESC"],
                "LIMIT" => $limit
            ]);
        } else {
            return $this->masterdatabase->select("mail_queue", [
                "[>]mail_templates" => ["template" => "name"],
            ], [
                "mail_queue.id",
                "mail_queue.template",
                "mail_templates.title",
                "mail_queue.done",
                "mail_queue.data",
                "mail_queue.created_on",
            ], [
                "mail_queue.userid" => $userid,
                "ORDER" => ["id" => "DESC"],
            ]);
        }
    }

}
